name: Trigger a new version using changeset

on:
  push:
    branches:
      - master
      - rc/*
      # - dev

env:
  HUSKY: 0
  TURBO_UI: 'false'

jobs:
  release:
    if: "!contains(github.event.head_commit.message, 'chore(release):')"
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v4

      - name: Setup pnpm ⚙️
        uses: pnpm/action-setup@v3

      - name: Setup Node ⚙️
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'pnpm'

      - name: Install dependencies ⚙️
        run: pnpm i --frozen-lockfile

      - name: Get prerelease state ⚗️
        id: prerelease_state
        run: |
          content=`cat ./.changeset/pre.json`
          # the following lines are only required for multi line json
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}"
          # end of optional handling for multi line json
          echo "::set-output name=preJson::$content"

      - name: Enter pre-release mode ⚗️
        if: "github.ref != 'refs/heads/master' && fromJson(steps.prerelease_state.outputs.preJson).mode != 'pre'"
        env:
          EZR_TAG: ${{ github.ref == 'refs/heads/dev' && 'beta' || 'rc' }}
        run: pnpm changeset pre enter $EZR_TAG

      - name: Exit pre-release mode ⚗️
        if: "github.ref == 'refs/heads/master' && fromJson(steps.prerelease_state.outputs.preJson).mode == 'pre'"
        run: pnpm changeset pre exit

      - name: Build changelogs 📝
        run: pnpm changeset version

      - name: Add tags 🔖
        run: pnpm changeset tag

      - name: Commit files 🚀
        uses: EndBug/add-and-commit@v9
        with:
          message: 'chore(release): publish changelogs'
          default_author: github_actions
          push: '--atomic'
