name: Generate database documentation of report database

on:
  push:
    branches:
      - 'rc/*'
    paths:
      - 'packages/database/prisma/**/*'

env:
  HUSKY: 0
  TURBO_UI: 'false'
  PRISMA_FOLDER: packages/database/prisma/
  OUT_ERD_PATH: docs/ERD.svg
  OUT_DIC_PATH: docs/DIC.md
  DIC_NAME: ezREEPORT
  ERD_WS: https://p-erd.oxypomme.fr
  ERD_WS_KEY: '${{ secrets.PRISMA_ERD_API_KEY }}'

jobs:
  generate-db-doc:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v4

      - name: Merge schema ⚙️
        run: 'find ${{ env.PRISMA_FOLDER }} -type f -name "*.prisma" -exec cat {} + > ${{ runner.temp }}/schema.prisma'

      - name: Generate ERD 🔧
        run: 'curl -X POST -d "$(cat ${{ runner.temp }}/schema.prisma)" -H "Content-Type: text/plain" -H "X-Api-Key: ${{ env.ERD_WS_KEY }}" -o "${{ env.OUT_ERD_PATH }}" ${{ env.ERD_WS }}/erd/'

      - name: Generate Data dictionary 🔧
        run: 'curl -X POST -d "$(cat ${{ runner.temp }}/schema.prisma)" -H "Content-Type: text/plain" -H "X-Api-Key: ${{ env.ERD_WS_KEY }}" -o "${{ env.OUT_DIC_PATH }}" ${{ env.ERD_WS }}/dict/\?name\=${{ env.DIC_NAME }}'

      # - name: Setup pnpm ⚙️
      #   uses: pnpm/action-setup@v3

      # - name: Setup Node ⚙️
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version-file: .nvmrc
      #     cache: 'pnpm'

      # - name: Install dependencies ⚙️
      #   run: pnpm i --frozen-lockfile

      - name: Commit files 🚀
        uses: EndBug/add-and-commit@v9
        with:
          message: 'docs: updated database documentation[skip ci]'
          default_author: github_actions
